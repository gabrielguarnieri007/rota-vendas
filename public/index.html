<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Rota Vendas</title>
    
    <meta property="og:title" content="Rota Vendas Premium">
    <meta property="og:image" content="https://rota-vendas-app.web.app/logo.jpg?v=74">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/jpeg" href="logo.jpg?v=74">
    <link rel="apple-touch-icon" href="logo.jpg?v=74">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    
    <style>
        :root { --bg-dark: #000000; --glass-dark: rgba(28, 28, 30, 0.95); --text-main: #ffffff; --text-sec: #8e8e93; --blue-ios: #0a84ff; --purple-ios: #bf5af2; --ease-cinema: cubic-bezier(0.22, 1, 0.36, 1); }
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Roboto, sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; touch-action: manipulation; user-select: none; }
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #e5e5e5; transition: opacity 1s ease; }
        
        /* FIX DE CLIQUE: Permite clicar no mapa atravÃ©s da Ã¡rea vazia da busca */
        #search-container { position: absolute; top: max(env(safe-area-inset-top), 20px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; z-index: 2000; transition: all 0.5s var(--ease-cinema); pointer-events: none; }
        .search-wrapper { background: rgba(28, 28, 30, 0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; display: flex; align-items: center; height: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding-right: 5px; pointer-events: auto; }
        
        #search-icon { margin-left: 20px; color: #8e8e93; }
        #search-box { width: 100%; padding: 0 15px; height: 100%; border: none; background: transparent; color: white; font-size: 16px; outline: none; }
        #btn-menu-trigger { background: transparent; border: none; color: white; width: 40px; height: 40px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 5px; transition: background 0.2s; }
        #search-results { background: #1c1c1e; width: 100%; margin-top: 10px; border-radius: 16px; overflow: hidden; display: none; border: 1px solid rgba(255,255,255,0.1); max-height: 40vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.6); pointer-events: auto; }
        .result-item { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }

        #side-menu { position: fixed; top: 0; right: 0; width: 280px; height: 100%; background: rgba(28, 28, 30, 0.98); backdrop-filter: blur(20px); z-index: 3000; transform: translateX(100%); transition: transform 0.4s var(--ease-cinema); box-shadow: -10px 0 40px rgba(0,0,0,0.5); border-left: 1px solid rgba(255,255,255,0.1); padding: 30px 20px; display: flex; flex-direction: column; }
        #side-menu.visible { transform: translateX(0); }
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .menu-title { font-size: 22px; font-weight: 800; color: white; letter-spacing: -0.5px; }
        #user-info-display { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; margin-bottom: 25px; font-size: 13px; color: #8e8e93; border: 1px solid rgba(255,255,255,0.05); }
        #user-email-text { color: white; font-weight: 700; font-size: 15px; display: block; margin-top: 4px; }
        .menu-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); color: white; padding: 18px; border-radius: 14px; text-align: left; font-size: 16px; font-weight: 600; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.2s; }
        .menu-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }
        .btn-logout-menu { color: #ff453a; border-color: rgba(255, 69, 58, 0.2); background: rgba(255, 69, 58, 0.05); margin-top: 10px; }
        .version-info { margin-top: auto; text-align: center; color: rgba(255,255,255,0.2); font-size: 11px; letter-spacing: 1px; }

        .fab-btn { position: absolute; width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 1000; font-size: 28px; transition: transform 0.3s var(--ease-cinema); pointer-events: auto !important; }
        .fab-btn:active { transform: scale(0.9); }
        #fab-add { bottom: 40px; right: 20px; background: white; color: black; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2500; display: none; opacity: 0; transition: opacity 0.5s ease; backdrop-filter: blur(4px); }
        #overlay.visible { display: block; opacity: 1; }

        /* MODAL (MOBILE FIRST) */
        .modal { 
            position: fixed; left: 0; bottom: 0; width: 100%; 
            background: #1c1c1e; border-radius: 32px 32px 0 0; padding: 0; z-index: 3000; 
            transform: translate3d(0, 100%, 0); 
            transition: transform 0.6s var(--ease-cinema); 
            box-shadow: 0 -10px 60px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column; max-height: 90vh; 
        }
        .modal.visible { transform: translate3d(0, 0, 0); }

        /* CORREÃ‡ÃƒO PARA DESKTOP (PC) - FORÃ‡ANDO VISUALIZAÃ‡ÃƒO CORRETA */
        @media (min-width: 768px) { 
            .modal { 
                left: 50%; top: 50%; bottom: auto; width: 450px; 
                border-radius: 24px; 
                /* Estado Inicial PC */
                transform: translate3d(-50%, -50%, 0) scale(0.95); 
                opacity: 0; 
                pointer-events: none; /* NÃ£o clica quando invisÃ­vel */
                transition: all 0.4s ease; /* TransiÃ§Ã£o mais simples */
            } 
            /* Estado VisÃ­vel PC - IMPORTANTE: Sobrescreve o transform do mobile */
            .modal.visible { 
                transform: translate3d(-50%, -50%, 0) scale(1) !important; 
                opacity: 1 !important; 
                pointer-events: auto;
            } 
        }

        .modal-header { padding: 25px 25px 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 24px; font-weight: 800; color: white; margin: 0; letter-spacing: -0.5px; }
        .btn-close-modal { background: rgba(255,255,255,0.1); border: none; width: 34px; height: 34px; border-radius: 50%; color: #8e8e93; font-size: 16px; cursor: pointer; }
        .modal-content { padding: 10px 25px 50px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        label { font-size: 12px; font-weight: 700; color: #8e8e93; margin-top: 15px; display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        input.form-input, select.form-input, .btn-salvar { width: 100%; padding: 18px; border-radius: 16px; font-size: 17px; box-sizing: border-box; outline: none; display: block; background: #2c2c2e; border: 1px solid #333; color: white; transition: all 0.3s ease; }
        input.form-input:focus { border-color: var(--blue-ios); background: #3a3a3c; }
        .btn-salvar { background: white; color: black; border: none; font-weight: 800; margin-top: 25px; cursor: pointer; }
        .btn-auto-end { background: var(--blue-ios); color: white; border: none; padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; margin-left: 10px; cursor: pointer; }
        #preview-foto-edit, #preview-logo-perfil { width: 100%; height: 200px; object-fit: contain; border-radius: 16px; display: none; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); }

        .add-item-row { display: flex; gap: 8px; margin-bottom: 15px; }
        .item-list { background: rgba(255,255,255,0.05); border-radius: 14px; padding: 10px; min-height: 50px; margin-bottom: 15px; }
        .item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; }
        .total-display { font-size: 24px; font-weight: 800; text-align: right; color: var(--blue-ios); margin: 20px 0; }
        .btn-add-item { background: #3a3a3c; color: white; border: none; border-radius: 12px; font-weight: 800; width: 50px; cursor: pointer; }
        
        .pedido-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .pedido-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 700; color: white; }
        .pedido-meta { font-size: 12px; color: #8e8e93; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pedido-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-ver-nota { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; width: 100%; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; flex: 1; }
        .btn-delete-pedido { background: rgba(255, 59, 48, 0.2); color: #ff453a; border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; padding: 10px; width: 50px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .cnpj-wrapper { display: flex; gap: 10px; align-items: center; }
        .btn-busca-cnpj { background: var(--purple-ios); border: none; color: white; width: 50px; height: 50px; border-radius: 14px; font-size: 18px; cursor: pointer; flex-shrink: 0; }

        /* PDF MODO PEDIDO (V65) */
        .pdf-pedido-wrapper { background: white; color: black; padding: 30px; font-family: sans-serif; border: 1px solid #ddd; font-size: 13px; }
        .pdf-pedido-header { border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; }
        /* DATA NO TOPO E ALINHAMENTO */
        .pdf-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        /* FONTE MENOR E SEM QUEBRA DE LINHA */
        .pdf-title { font-size: 16px; font-weight: 800; text-transform: uppercase; margin: 0; white-space: nowrap; }
        .cliente-info-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .cliente-info-table td { padding: 4px 0; vertical-align: top; }
        .cliente-label { font-weight: 800; width: 100px; color: #333; }
        .cliente-value { color: #000; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        .pdf-table th { text-align: left; border-bottom: 2px solid black; padding: 8px 5px; background: #f2f2f2; font-weight: 800; font-size: 12px; text-transform: uppercase; }
        .pdf-table td { padding: 10px 5px; border-bottom: 1px solid #eee; }
        .pdf-footer { margin-top: 50px; display: flex; justify-content: space-between; }
        .pdf-signature { border-top: 1px solid #000; width: 45%; text-align: center; padding-top: 5px; font-size: 10px; }

        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000000; transition: opacity 0.8s ease, visibility 0.8s; }
        #splash-bg { position: absolute; top:0; left:0; width:100%; height:100%; background: url('https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=1000&auto=format&fit=crop') no-repeat center center; background-size: cover; opacity: 0.4; filter: grayscale(100%); z-index: 0; }
        .login-box { position: relative; z-index: 2; width: 85%; max-width: 320px; text-align: center; opacity: 0; transform: translateY(20px); transition: all 0.8s var(--ease-cinema); display: none; }
        .login-box.active { display: block; opacity: 1; transform: translateY(0); }
        .login-field { width: 100%; height: 55px; padding: 0 16px; border-radius: 14px; font-size: 16px; margin-bottom: 12px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; }
        .input-login-fixed { background: rgba(28,28,30,0.8); border: 1px solid rgba(255,255,255,0.2); color: white; outline: none; text-align: center; backdrop-filter: blur(10px); }
        .btn-login-premium { background: white; color: black; border: none; font-weight: 800; letter-spacing: 1px; cursor: pointer; box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-top: 10px; }
        #initial-loader { position: relative; z-index: 2; text-align: center; transition: opacity 0.5s ease; }
        
        #global-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: 600; }

        #center-pin { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 1000; display: none; }
        #center-pin i { font-size: 50px; color: #FF3B30; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #manual-actions { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 2000; display: none; flex-direction: column; gap: 12px; }
        .btn-confirm-map { background: #34C759; color: white; padding: 18px; border-radius: 50px; border: none; font-weight: 800; font-size: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); letter-spacing: 0.5px; cursor: pointer; }
        .btn-cancel-map { background: rgba(28,28,30,0.9); backdrop-filter: blur(10px); color: #ff453a; padding: 18px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); font-weight: 700; font-size: 16px; cursor: pointer; }
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2300; display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 25px; }
        
        .city-block { margin-bottom: 20px; page-break-inside: auto; }
        .city-title { background: var(--blue-ios); color: white; padding: 10px 15px; border-radius: 10px; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; page-break-after: avoid; }
        .bairro-container { margin-left: 10px; margin-bottom: 10px; page-break-inside: auto; }
        .bairro-header { background: #2c2c2e; padding: 10px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: white; font-weight: 600; font-size: 14px; page-break-after: avoid; }
        .bairro-lista { display: none; padding: 5px 10px; background: #1c1c1e; border-top: none; border-radius: 0 0 10px 10px; color: white; }
        .cliente-no-bairro { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #cecece; font-size: 13px; }
        .relatorio-titulo { color: white; }
        .relatorio-sub { color: #8e8e93; }

        .pdf-mode { background-color: white !important; color: black !important; padding: 20px !important; }
        .pdf-mode .city-title { background-color: #000 !important; color: white !important; margin-top: 15px; }
        .pdf-mode .bairro-header { background-color: #f2f2f7 !important; color: black !important; border: 1px solid #ccc !important; }
        .pdf-mode .bairro-lista { background-color: white !important; color: black !important; border: 1px solid #ccc !important; display: block !important; padding: 0 10px !important; } 
        .pdf-mode .cliente-no-bairro { color: #333 !important; border-bottom: 1px solid #ccc !important; }
        .pdf-mode .relatorio-titulo { color: black !important; }
        .pdf-mode .relatorio-sub { color: #555 !important; }

        #modal-foto-grande { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #modal-foto-grande.active { opacity: 1; }
        #img-grande { max-width: 100%; max-height: 100%; }
        #btn-fechar-foto { position: absolute; top: 40px; right: 20px; background: rgba(50,50,50,0.5); width: 44px; height: 44px; border-radius: 50%; border:none; color: white; font-size: 20px; z-index: 3001; backdrop-filter: blur(5px); }
        #ios-install-prompt { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(28, 28, 30, 0.95); padding: 25px; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); z-index: 999999; text-align: center; border-radius: 25px 25px 0 0; backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); color: white; }
        .cep-wrapper { display: flex; gap: 10px; align-items: center; }
        .btn-busca-cep { background: #34C759; border: none; color: white; width: 50px; height: 50px; border-radius: 14px; font-size: 18px; cursor: pointer; flex-shrink: 0; }

        @media print { body { background: white; color: black; } #map, #search-container, .fab-btn { display: none !important; } }
    </style>
</head>
<body>

    <div id="global-loading">
        <i class="fas fa-spinner fa-spin" style="font-size:40px; margin-bottom:20px;"></i>
        <div id="loading-text">Processando...</div>
    </div>

    <div id="side-menu">
        <div class="menu-header">
            <div class="menu-title">Menu</div>
            <button class="btn-close-modal" onclick="toggleMenu()"><i class="fas fa-times"></i></button>
        </div>
        
        <div id="user-info-display">Conectado como:<span id="user-email-text">Carregando...</span></div>

        <button class="menu-btn" onclick="abrirPerfil()"><i class="fas fa-user-cog" style="color:#ffffff;"></i> ðŸ‘¤ Meu Perfil</button>
        <button class="menu-btn" onclick="abrirRelatorio()"><i class="fas fa-chart-pie" style="color:#0a84ff;"></i> RelatÃ³rios de Rota</button>
        <button class="menu-btn" onclick="verMeusPedidos()"><i class="fas fa-clipboard-list" style="color:#bf5af2;"></i> ðŸ“¦ Meus Pedidos</button>
        <button class="menu-btn" onclick="forcarRecarregamentoDados()"><i class="fas fa-cloud-download-alt" style="color:#FF9500;"></i> Recarregar Clientes</button>
        <button class="menu-btn" onclick="window.location.reload(true)"><i class="fas fa-sync-alt" style="color:#34C759;"></i> Atualizar App</button>
        
        <button class="menu-btn btn-logout-menu" onclick="fazerLogout()"><i class="fas fa-power-off"></i> Sair da Conta</button>
        <div class="version-info">VersÃ£o 74.0 (Fix PC)</div>
    </div>

    <div id="modal-perfil" class="modal">
        <div class="modal-header"><h3 class="modal-title">Meu Perfil</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div>
        <div class="modal-content">
            <label>Nome da Sua Empresa</label>
            <input type="text" id="perfilNomeEmpresa" class="form-input" placeholder="Ex: Chagas RepresentaÃ§Ãµes">
            
            <label>Logo da Empresa (Para PDF)</label>
            <img id="preview-logo-perfil" src="" alt="Logo">
            <label for="inputLogoPerfil" style="background:#2c2c2e; padding:20px; border-radius:16px; text-align:center; cursor:pointer; color:white; border:1px dashed #444; margin-top:0; display:block;">
                <i class="fas fa-image" style="font-size:20px; margin-bottom:5px; display:block;"></i> Alterar Logo
            </label>
            <input type="file" id="inputLogoPerfil" class="file-upload" accept="image/*" style="display:none;" onchange="previewLogo(this)">
            
            <button class="btn-salvar" onclick="salvarPerfil()">ðŸ’¾ SALVAR CONFIGURAÃ‡ÃƒO</button>
        </div>
    </div>

    <div id="modal-novo-pedido" class="modal">
        <div class="modal-header"><h3 class="modal-title">Novo Pedido</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div>
        <div class="modal-content">
            <label>Cliente / RazÃ£o Social</label>
            <input type="text" id="pedidoClienteNome" class="form-input">
            <input type="hidden" id="pedidoClienteId">
            <label>CNPJ (Busca Auto)</label>
            <div class="cnpj-wrapper"><input type="tel" id="pedidoCnpj" class="form-input" placeholder="00.000.000/0000-00"><button class="btn-busca-cnpj" onclick="buscarDadosCnpj()"><i class="fas fa-search"></i></button></div>
            <label>EndereÃ§o Completo</label><input type="text" id="pedidoEndereco" class="form-input" placeholder="Rua, Bairro, Cidade...">
            <div style="display:flex; gap:10px;"><div style="flex:1;"><label>Contato</label><input class="form-input" type="text" id="pedidoContato" placeholder="Nome"></div><div style="flex:1;"><label>Telefone</label><input class="form-input" type="tel" id="pedidoTelefone" placeholder="(00) 0..."></div></div>
            <label>CondiÃ§Ãµes de Pagamento</label><input type="text" id="pedidoPagamento" class="form-input" placeholder="Ex: 30/60 dias">
            <label style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">Adicionar Produtos</label>
            <div class="add-item-row"><input type="text" id="itemNome" class="form-input" placeholder="Produto" style="flex:2;"><input type="number" id="itemQtd" class="form-input" placeholder="Qtd" style="flex:1;"></div>
            <div class="add-item-row"><input type="number" id="itemPreco" class="form-input" placeholder="R$ Unit." style="flex:2;"><button class="btn-add-item" onclick="adicionarItemPedido()">+</button></div>
            <div id="lista-itens-pedido" class="item-list"><div style="text-align:center; color:#555; padding:10px;">Nenhum item adicionado</div></div>
            <div class="total-display" id="totalPedido">R$ 0,00</div>
            <button class="btn-salvar" style="background:var(--purple-ios); color:white;" onclick="salvarPedido()">âœ… FINALIZAR PEDIDO</button>
        </div>
    </div>

    <div id="modal-meus-pedidos" class="modal">
        <div class="modal-header"><h3 class="modal-title">Meus Pedidos</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div>
        <div class="modal-content"><div id="lista-pedidos-historico">Carregando...</div></div>
    </div>

    <div id="modal-pdf-pedido" class="modal">
        <div class="modal-header"><h3 class="modal-title">Visualizar Pedido</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div>
        <div class="modal-content"><div id="conteudo-pdf-pedido"></div><button class="btn-salvar" onclick="baixarPDFPedido()">ðŸ“„ Baixar / Compartilhar</button></div>
    </div>

    <div id="modal-foto-grande"><button id="btn-fechar-foto" onclick="fecharFotoGrande()"><i class="fas fa-times"></i></button><img id="img-grande" src="" alt="Foto Ampliada"></div>
    <div id="center-pin"><i class="fas fa-map-marker-alt"></i></div>
    <div id="manual-actions"><button class="btn-confirm-map" onclick="confirmarLocalizacaoManual()">CONFIRMAR LOCAL</button><button class="btn-cancel-map" onclick="cancelarMapaManual()">Cancelar</button></div>
    <div id="print-area"><h2 style="color:black;">RelatÃ³rio Rota Vendas</h2><div id="print-content"></div></div>

    <div id="splash">
        <div id="splash-bg"></div>
        <div id="initial-loader"><img src="logo.jpg?v=74" style="width: 100px; margin-bottom: 20px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.5);"><div style="color:rgba(255,255,255,0.6); font-size:14px; font-weight:500;">Acessando Rota...</div></div>
        <div class="login-box" id="login-form-box">
            <img src="logo.jpg?v=74" style="width: 130px; margin-bottom: 30px; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.6);">
            <h2 style="margin-bottom: 5px; font-weight: 800; font-size: 26px; letter-spacing: -0.5px;">ROTA VENDAS</h2>
            <p style="margin-top: 0; opacity: 0.6; margin-bottom: 40px; font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Corporativo</p>
            <input type="email" id="emailLogin" class="input-login-fixed login-field" placeholder="E-mail">
            <input type="password" id="senhaLogin" class="input-login-fixed login-field" placeholder="Senha">
            <button class="btn-login-premium login-field" onclick="fazerLogin()">ENTRAR</button>
            <p id="msgErroLogin" style="color: #ff453a; margin-top: 20px; font-weight: 600; display: none;"></p>
        </div>
    </div>

    <div id="search-container"><div class="search-wrapper"><i class="fas fa-search" id="search-icon"></i><input type="text" id="search-box" placeholder="Buscar cliente..." onkeyup="filtrarClientes()"><button id="btn-menu-trigger" onclick="toggleMenu()"><i class="fas fa-bars"></i></button></div><div id="search-results"></div></div>
    <div id="map"></div>
    <div id="toast-msg" style="position:fixed; bottom: 100px; left:50%; transform:translateX(-50%); background:rgba(30,30,30,0.95); color:white; padding:14px 28px; border-radius:50px; display:none; z-index:3000; font-size:15px; font-weight:600; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1);"></div>
    <button id="fab-add" class="fab-btn" onclick="abrirEscolha()"><i class="fas fa-plus"></i></button>
    <div id="overlay" onclick="toggleMenu(false); fecharModais()"></div>

    <div id="modal-form" class="modal"><div id="loading-overlay"><i class="fas fa-spinner fa-spin" style="font-size:30px; margin-bottom:15px;"></i>Salvando...</div><div class="modal-header"><h3 class="modal-title" id="form-title">Cliente</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div><div class="modal-content"><img id="preview-foto-edit" src="" onclick="verFotoGrande(this.src)"><label style="margin-top:0;">CEP (Opcional)</label><div class="cep-wrapper"><input type="tel" id="inputCep" class="form-input" placeholder="00000-000"><button class="btn-busca-cep" onclick="buscarPorCep()"><i class="fas fa-search"></i></button></div><label>Status</label><select id="inputStatus" class="form-input"><option value="azul">ðŸ”µ Em Aberto</option><option value="verde">ðŸŸ¢ ConcluÃ­da</option><option value="vermelho">ðŸ”´ Sede / EscritÃ³rio</option></select><label>Empresa / Obra</label><input class="form-input" type="text" id="inputNome" placeholder="Nome do local"><div style="display:flex; gap:10px;"><div style="flex:1;"><label>Cidade</label><input class="form-input" type="text" id="inputCidade"></div><div style="flex:1;"><label>Bairro <span class="btn-auto-end" onclick="acionarBuscaManual()">Auto</span></label><input class="form-input" type="text" id="inputBairro"></div></div><label>EndereÃ§o / NÂº</label><input class="form-input" type="text" id="inputObs" placeholder="Rua, NÃºmero..."><label>Contato</label><input class="form-input" type="text" id="inputComprador"><label>Telefone</label><input class="form-input" type="tel" id="inputTel" placeholder="(00) 00000-0000"><label>Foto</label><label for="inputFoto" style="background:#2c2c2e; padding:20px; border-radius:16px; text-align:center; cursor:pointer; color:white; border:1px dashed #444; margin-top:0; display:block;"><i class="fas fa-camera" style="font-size:20px; margin-bottom:5px; display:block;"></i> Toque para foto</label><input type="file" id="inputFoto" class="file-upload" accept="image/*" style="display:none;"><button class="btn-salvar" id="btn-confirmar" onclick="salvarCliente()">SALVAR</button></div></div>
    <div id="modal-escolha" class="modal"><div class="modal-header"><h3 class="modal-title">Novo Cliente</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div><div class="modal-content" style="text-align: center;"><button class="btn-salvar" style="background:var(--blue-ios); color:white; margin-bottom:15px; margin-top: 10px;" onclick="usarGPS()"><i class="fas fa-location-arrow"></i> Usar GPS</button><button class="btn-salvar" style="background:#2c2c2e; color:white; margin-top:0; margin-bottom:15px;" onclick="usarMapaManual()"><i class="fas fa-map-pin"></i> Escolher no Mapa</button><button class="btn-salvar" style="background:#FF9500; color:white; margin-top:0;" onclick="abrirFormularioCEP()"><i class="fas fa-search"></i> Buscar por CEP</button></div></div>
    <div id="modal-report" class="modal"><div class="modal-header"><h3 class="modal-title">RelatÃ³rios</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div><div class="modal-content"><div id="conteudo-pdf"><div id="report-body"></div></div><button class="btn-salvar" style="background:#2c2c2e; color:white;" onclick="baixarPDF()">ðŸ“„ Baixar PDF</button></div></div>
    <div id="modal-contato" class="modal"><div class="modal-header"><h3 class="modal-title">Contato</h3><button class="btn-close-modal" onclick="fecharModais()"><i class="fas fa-times"></i></button></div><div class="modal-content"><p style="color:var(--text-sec); text-align:center; font-size:20px; font-weight:600; margin-bottom: 35px;" id="numero-contato-display">--</p><a id="link-whatsapp" href="#" target="_blank" style="text-decoration:none;"><button class="btn-salvar" style="background:#25D366; color:white; margin-top:0; margin-bottom:12px;"><i class="fab fa-whatsapp"></i> WhatsApp</button></a><a id="link-tel" href="#" style="text-decoration:none;"><button class="btn-salvar" style="background:#3a3a3c; color:white; margin-top:0;"><i class="fas fa-phone"></i> Ligar</button></a></div></div>

    <div id="ios-install-prompt"><button onclick="document.getElementById('ios-install-prompt').style.display='none'" style="position: absolute; top: 15px; right: 20px; border: none; background: none; font-size: 24px; color: #888;">Ã—</button><img src="logo.jpg?v=74" style="width: 70px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);"><h3 style="margin: 0 0 5px 0; color: white;">Instale o App</h3><p style="margin: 0 0 20px 0; font-size: 14px; color: #aaa;">Adicione Ã  tela de inÃ­cio para tela cheia.</p><div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; font-weight: 600; color: #007AFF;"><span>1. Toque em Compartilhar</span><i class="fas fa-share-square" style="font-size: 20px;"></i></div><div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; font-weight: 600; color: #007AFF; margin-top: 10px;"><span>2. "Adicionar Ã  Tela de InÃ­cio"</span><i class="far fa-plus-square" style="font-size: 20px;"></i></div><div style="margin-top: 20px; animation: bounce 2s infinite;"><i class="fas fa-arrow-down" style="font-size: 24px; color: white;"></i></div></div>
    
    <script>
        function isIos() { const userAgent = window.navigator.userAgent.toLowerCase(); return /iphone|ipad|ipod/.test(userAgent); }
        function isInStandaloneMode() { return ('standalone' in window.navigator) && (window.navigator.standalone); }
        if (isIos() && !isInStandaloneMode()) { setTimeout(() => { document.getElementById('ios-install-prompt').style.display = 'block'; }, 1000); }
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, getDoc, setDoc, query, where, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURAÃ‡ÃƒO ATIVA: PRODUÃ‡ÃƒO (ROTA-VENDAS-APP) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDnjrATzH5JhLdU1Ai3rzMuvLykodtgqvU",
            authDomain: "rota-vendas-app.firebaseapp.com",
            projectId: "rota-vendas-app",
            storageBucket: "rota-vendas-app.firebasestorage.app",
            messagingSenderId: "198405945906",
            appId: "1:198405945906:web:981e967be2270ebb8cda2b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        try { enableIndexedDbPersistence(db).catch(e => console.log("Persistencia: " + e.code)); } catch(e){}

        window.listaPedidosGlobal = [];
        let configUsuario = { nome: "ROTA VENDAS", logo: "logo.jpg?v=74" };

        let map; let tempMarker = null; let coordSelecionada = null; let listaClientesLocal = []; let markersMap = {}; let idParaEditar = null; let usuarioAtual = null; let timerLimpeza = null; let viewer = null;
        let itensPedidoAtual = [];

        function showLoading(msg) { document.getElementById('loading-text').innerText = msg; document.getElementById('global-loading').style.display = 'flex'; }
        function hideLoading() { document.getElementById('global-loading').style.display = 'none'; }

        // HELPER FUNCTIONS
        const setStyle = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };

        onAuthStateChanged(auth, async (user) => {
            const splash = document.getElementById('splash');
            const loader = document.getElementById('initial-loader');
            const loginForm = document.getElementById('login-form-box');
            if (user) {
                usuarioAtual = user;
                if(document.getElementById('user-email-text')) document.getElementById('user-email-text').innerText = user.email;
                
                await carregarConfiguracoes();

                if(splash) splash.style.opacity = '0';
                setTimeout(() => { 
                    if(splash) splash.style.display = 'none'; 
                    setStyle('fab-add', 'display', 'flex');
                    setStyle('search-container', 'display', 'block');
                }, 800);
                if(!map) iniciarMapa(); 
                carregarClientes(false, user);
            } else {
                if(loader) loader.style.opacity = '0'; 
                setTimeout(() => { 
                    if(loader) loader.style.display = 'none'; 
                    if(loginForm) loginForm.classList.add('active'); 
                }, 500);
                setStyle('fab-add', 'display', 'none');
                setStyle('search-container', 'display', 'none');
            }
        });

        // --- LÃ“GICA DE PERFIL ---
        async function carregarConfiguracoes() {
            try {
                const docRef = doc(db, "configuracoes", usuarioAtual.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    configUsuario.nome = data.nome || "ROTA VENDAS";
                    configUsuario.logo = data.logo || "logo.jpg?v=74";
                }
            } catch (e) { console.log("Erro config:", e); }
        }

        window.abrirPerfil = function() {
            toggleMenu(false);
            setVal('perfilNomeEmpresa', configUsuario.nome);
            const img = document.getElementById('preview-logo-perfil');
            if(img) { img.src = configUsuario.logo; img.style.display = 'block'; }
            abrirModal('modal-perfil');
        }

        window.previewLogo = async function(input) {
            if (input.files && input.files[0]) {
                const base64 = await redimensionarImagem(input.files[0]);
                const img = document.getElementById('preview-logo-perfil');
                img.src = base64;
                img.style.display = 'block';
            }
        }

        window.salvarPerfil = async function() {
            const novoNome = getVal('perfilNomeEmpresa');
            const img = document.getElementById('preview-logo-perfil');
            const novaLogo = img.src;

            if(!novoNome) return alert("Digite o nome da empresa.");

            showLoading("Salvando Perfil...");
            try {
                await setDoc(doc(db, "configuracoes", usuarioAtual.uid), {
                    nome: novoNome,
                    logo: novaLogo
                }, { merge: true });
                
                configUsuario.nome = novoNome;
                configUsuario.logo = novaLogo;
                
                alert("Perfil atualizado!");
                fecharModais();
            } catch(e) {
                alert("Erro: " + e.message);
            } finally {
                hideLoading();
            }
        }
        // -------------------------------

        window.toggleMenu = function(forceClose) {
            const menu = document.getElementById('side-menu'); const overlay = document.getElementById('overlay');
            if(!menu || !overlay) return;
            const isOpen = menu.classList.contains('visible');
            if (forceClose === false || isOpen) { 
                menu.classList.remove('visible'); 
                overlay.classList.remove('visible'); 
                setTimeout(() => { overlay.style.display = 'none'; }, 400); 
            } else { 
                overlay.style.display = 'block'; 
                setTimeout(() => { menu.classList.add('visible'); overlay.classList.add('visible'); }, 10); 
            }
        }

        window.fazerLogin = function() {
            const email = getVal('emailLogin'); const senha = getVal('senhaLogin');
            if(!email || !senha) return;
            document.querySelector('.btn-login-premium').innerText = "VERIFICANDO...";
            signInWithEmailAndPassword(auth, email, senha).catch((error) => { 
                setStyle('msgErroLogin', 'display', 'block'); 
                const erroEl = document.getElementById('msgErroLogin');
                if(erroEl) erroEl.innerText = "Acesso Negado."; 
                document.querySelector('.btn-login-premium').innerText = "ENTRAR"; 
            });
        }
        window.fazerLogout = function() { if(confirm("Deseja sair?")) signOut(auth).then(() => window.location.reload()); }
        window.verFotoGrande = (src) => { if(src){ if (viewer) viewer.destroy(); const image = new Image(); image.src = src; viewer = new Viewer(image, { toolbar: false, navbar: false, title: false, button: true, transition: false, zoomRatio: 0.3 }); viewer.show(); } }

        const IconConfig = { iconSize: [30, 46], iconAnchor: [15, 46], popupAnchor: [1, -40], shadowSize: [41, 41] };
        const blueIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', ...IconConfig });
        const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', ...IconConfig });
        const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', ...IconConfig });

        function iniciarMapa() {
            // ZOOM AJUSTADO MA/PI (V74)
            map = L.map('map', { center: [-6.5, -44.0], zoom: 6, zoomControl: false });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 }).addTo(map);
            map.on('click', () => { setStyle('search-results', 'display', 'none'); });
        }

        window.buscarDadosCnpj = async function() {
            let cnpj = getVal('pedidoCnpj').replace(/\D/g, '');
            if(cnpj.length !== 14) return alert("CNPJ invÃ¡lido (digite 14 nÃºmeros)");
            const btn = document.querySelector('.btn-busca-cnpj'); const icon = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const res = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                if(!res.ok) throw new Error("CNPJ nÃ£o encontrado");
                const data = await res.json();
                setVal('pedidoClienteNome', data.nome_fantasia || data.razao_social);
                const enderecoFull = `${data.logradouro}, ${data.numero} - ${data.bairro}, ${data.municipio}-${data.uf}`;
                setVal('pedidoEndereco', enderecoFull);
                let tel = "";
                if(data.ddd_telefone_1 && data.telefone_1) { tel = `(${data.ddd_telefone_1}) ${data.telefone_1}`; }
                else if (data.telefone_1) { tel = data.telefone_1; }
                setVal('pedidoTelefone', tel);
                alert("Dados da empresa carregados!");
            } catch (e) { alert("Erro ao buscar CNPJ: " + e.message); } finally { btn.innerHTML = icon; }
        }

        function abrirModal(id) {
            if(timerLimpeza) clearTimeout(timerLimpeza);
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById(id);
            if(overlay) { overlay.style.display = 'block'; setTimeout(() => overlay.classList.add('visible'), 10); }
            if(modal) { modal.style.display = 'flex'; setTimeout(() => modal.classList.add('visible'), 10); }
        }

        window.abrirNovoPedido = function(id, nome) {
            fecharModais(); itensPedidoAtual = [];
            const c = listaClientesLocal.find(x => x.id === id);
            setVal('pedidoClienteNome', nome); setVal('pedidoClienteId', id); setVal('pedidoCnpj', "");
            if(c) {
                let end = ""; if(c.obs) end += c.obs; if(c.bairro) end += ` - ${c.bairro}`; if(c.cidade) end += `, ${c.cidade}`;
                setVal('pedidoEndereco', end); setVal('pedidoTelefone', c.telefone || ""); setVal('pedidoContato', c.comprador || "");
            } else { setVal('pedidoEndereco', ""); setVal('pedidoTelefone', ""); setVal('pedidoContato', ""); }
            setVal('pedidoPagamento', ""); setVal('itemNome', ""); setVal('itemQtd', ""); setVal('itemPreco', "");
            atualizarListaItens(); abrirModal('modal-novo-pedido');
        }

        window.adicionarItemPedido = function() {
            const nome = getVal('itemNome'); const qtd = parseFloat(getVal('itemQtd')); const preco = parseFloat(getVal('itemPreco'));
            if(!nome || !qtd || !preco) return alert("Preencha o item");
            itensPedidoAtual.push({ nome, qtd, preco });
            setVal('itemNome', ""); setVal('itemQtd', ""); setVal('itemPreco', ""); 
            const campoNome = document.getElementById('itemNome'); if(campoNome) campoNome.focus();
            atualizarListaItens();
        }

        function atualizarListaItens() {
            const container = document.getElementById('lista-itens-pedido'); if(!container) return;
            container.innerHTML = ""; let total = 0;
            if(itensPedidoAtual.length === 0) { container.innerHTML = '<div style="text-align:center; color:#555; padding:10px;">Nenhum item adicionado</div>'; } 
            else {
                itensPedidoAtual.forEach((item, index) => {
                    const subtotal = item.qtd * item.preco; total += subtotal;
                    const div = document.createElement('div'); div.className = 'item-row';
                    div.innerHTML = `<span>${item.nome} (${item.qtd}x)</span><span>R$ ${subtotal.toFixed(2)}</span>`; container.appendChild(div);
                });
            }
            const totalEl = document.getElementById('totalPedido'); if(totalEl) totalEl.innerText = `R$ ${total.toFixed(2)}`;
        }

        window.salvarPedido = async function() {
            if(itensPedidoAtual.length === 0) return alert("Adicione itens ao pedido");
            showLoading("Salvando Pedido...");
            const pedido = {
                uid: usuarioAtual.uid, clienteId: getVal('pedidoClienteId'), clienteNome: getVal('pedidoClienteNome'),
                cnpj: getVal('pedidoCnpj'), endereco: getVal('pedidoEndereco'), contato: getVal('pedidoContato'),
                telefone: getVal('pedidoTelefone'), pagamento: getVal('pedidoPagamento'),
                itens: itensPedidoAtual, total: itensPedidoAtual.reduce((acc, item) => acc + (item.qtd * item.preco), 0), data: new Date()
            };
            try { await addDoc(collection(db, "pedidos"), pedido); alert("Pedido Salvo com Sucesso!"); fecharModais(); } 
            catch(e) { alert("Erro: " + e.message); } finally { hideLoading(); }
        }

        window.verMeusPedidos = async function() {
            toggleMenu(false); abrirModal('modal-meus-pedidos'); const div = document.getElementById('lista-pedidos-historico'); 
            if(div) div.innerHTML = "Carregando...";
            const q = query(collection(db, "pedidos"), where("uid", "==", usuarioAtual.uid)); const snap = await getDocs(q);
            if(div) div.innerHTML = ""; 
            if(snap.empty && div) { div.innerHTML = "<div style='text-align:center; color:#888;'>Nenhum pedido encontrado.</div>"; return; }
            window.listaPedidosGlobal = []; let i = 0;
            snap.forEach(doc => {
                const p = doc.data(); p.id = doc.id; window.listaPedidosGlobal.push(p);
                const dataFormatada = p.data.toDate().toLocaleDateString('pt-BR'); 
                const html = `<div class="pedido-card"><div class="pedido-header"><span>${p.clienteNome}</span><span style="color:#32d74b;">R$ ${p.total.toFixed(2)}</span></div><div class="pedido-meta"><span>${dataFormatada}</span><span>${p.itens.length} itens</span></div><div class="pedido-actions"><button class="btn-ver-nota" onclick="prepararPDFPedido(${i})"><i class="fas fa-print"></i> Ver Nota / Imprimir</button><button class="btn-delete-pedido" onclick="deletarPedido('${doc.id}')"><i class="fas fa-trash"></i></button></div></div>`;
                if(div) div.innerHTML += html;
                i++;
            });
        }
        
        window.deletarPedido = async function(id) {
            if(confirm("Tem certeza que deseja apagar este pedido?")) {
                try { await deleteDoc(doc(db, "pedidos", id)); verMeusPedidos(); } catch(e) { alert("Erro ao apagar: " + e.message); }
            }
        }

        window.prepararPDFPedido = function(index) {
            const p = window.listaPedidosGlobal[index];
            const dataFormatada = new Date(p.data.seconds * 1000).toLocaleDateString('pt-BR');
            const div = document.getElementById('conteudo-pdf-pedido');
            let itensHtml = "";
            p.itens.forEach(i => { itensHtml += `<tr><td>${i.nome}</td><td style="text-align:center;">${i.qtd}</td><td style="text-align:right;">R$ ${i.preco.toFixed(2)}</td><td style="text-align:right;">R$ ${(i.qtd * i.preco).toFixed(2)}</td></tr>`; });
            let telefoneDisplay = (p.telefone || '').replace(/undefined/g, '').trim();
            
            const logoHTML = configUsuario.logo ? `<img src="${configUsuario.logo}" style="max-height:60px; margin-bottom:10px;">` : '';
            const nomeHTML = `<h2 class="pdf-title">${configUsuario.nome}</h2>`;

            div.innerHTML = `<div class="pdf-pedido-wrapper"><div class="pdf-pedido-header"><div class="pdf-header-top"><div>${logoHTML}${nomeHTML}</div><div>Data: <strong>${dataFormatada}</strong></div></div><table class="cliente-info-table"><tr><td class="cliente-label">Cliente:</td><td class="cliente-value">${p.clienteNome}</td></tr><tr><td class="cliente-label">CNPJ/CPF:</td><td class="cliente-value">${p.cnpj || '-'}</td></tr><tr><td class="cliente-label">EndereÃ§o:</td><td class="cliente-value">${p.endereco || '-'}</td></tr><tr><td class="cliente-label">Contato:</td><td class="cliente-value">${p.contato || '-'}</td></tr><tr><td class="cliente-label">Telefone:</td><td class="cliente-value">${telefoneDisplay}</td></tr><tr><td class="cliente-label">Pagamento:</td><td class="cliente-value">${p.pagamento || '-'}</td></tr></table></div><table class="pdf-table"><thead><tr><th>Produto</th><th style="text-align:center;">Qtd</th><th style="text-align:right;">Unit.</th><th style="text-align:right;">Total</th></tr></thead><tbody>${itensHtml}</tbody><tfoot><tr><td colspan="4" style="text-align:left; font-weight:bold; padding-top:20px; font-size:16px; padding-left: 2px;">TOTAL: R$ ${p.total.toFixed(2)}</td></tr></tfoot></table><div class="pdf-footer"><div class="pdf-signature">Assinatura do ResponsÃ¡vel</div><div class="pdf-signature">Assinatura do Cliente</div></div></div>`;
            abrirModal('modal-pdf-pedido');
        }

        window.baixarPDFPedido = async function() {
            const element = document.getElementById('conteudo-pdf-pedido'); const btn = document.querySelector('#modal-pdf-pedido .btn-salvar'); const originalText = btn.innerText; btn.innerText = "Preparando...";
            const opt = { margin: 10, filename: 'Pedido_Venda.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            try {
                const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
                const file = new File([pdfBlob], "Pedido_Venda.pdf", { type: "application/pdf" });
                if (navigator.share && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: 'Pedido de Venda', text: 'Segue em anexo o pedido de venda.', }); } 
                else { html2pdf().set(opt).from(element).save(); }
            } catch (error) { html2pdf().set(opt).from(element).save(); } finally { btn.innerText = originalText; }
        }

        window.filtrarClientes = function() {
            const termo = getVal('search-box').toLowerCase();
            const container = document.getElementById('search-results'); if(!container) return;
            container.innerHTML = ''; if (termo.length < 1) { container.style.display = 'none'; return; }
            const res = listaClientesLocal.filter(c => c.nome.toLowerCase().includes(termo) || (c.cidade && c.cidade.toLowerCase().includes(termo)));
            if (res.length > 0) {
                container.style.display = 'block';
                res.forEach(c => {
                    const div = document.createElement('div'); div.className = 'result-item';
                    div.innerHTML = `<span style="font-weight:bold; color:white;">${c.nome}</span><br><span style="font-size:12px; color:#888;">${c.cidade || ''}</span>`;
                    div.onclick = () => { container.style.display = 'none'; setVal('search-box', c.nome); requestAnimationFrame(() => { map.flyTo([c.lat, c.lng], 17); if (markersMap[c.id]) markersMap[c.id].openPopup(); }); };
                    container.appendChild(div);
                });
            } else { container.style.display = 'none'; }
        }

        window.escolherContato = function(numero) {
            const n = numero.replace(/\D/g, ''); document.getElementById('numero-contato-display').innerText = numero;
            document.getElementById('link-whatsapp').href = `https://wa.me/55${n}`; document.getElementById('link-tel').href = `tel:${n}`; abrirModal('modal-contato');
        }

        window.baixarPDF = function() {
            const el = document.getElementById('conteudo-pdf'); const btn = document.querySelector('#modal-report .btn-salvar'); const originalText = btn.innerText; btn.innerText = "â³ Gerando...";
            const tituloOriginal = el.innerHTML;
            const logoHTML = configUsuario.logo ? `<img src="${configUsuario.logo}" style="max-height:50px; display:block; margin:0 auto 10px;">` : '';
            const cabecalhoPersonalizado = `<div style="text-align:center; margin-bottom:20px;">${logoHTML}<h2 style="margin:0; font-size:24px; text-transform:uppercase;">${configUsuario.nome}</h2></div>`;
            el.innerHTML = cabecalhoPersonalizado + tituloOriginal;
            document.querySelectorAll('.bairro-lista').forEach(l => l.style.display = 'block'); el.classList.add('pdf-mode');
            const opt = { margin: 5, filename: 'Relatorio_Rota.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: 'css', avoid: ['.city-title', '.bairro-header'] } };
            html2pdf().set(opt).from(el).save().then(() => { 
                btn.innerText = originalText; el.classList.remove('pdf-mode'); 
                document.querySelectorAll('.bairro-lista').forEach(l => l.style.display = 'none');
                el.innerHTML = tituloOriginal; 
            });
        }

        window.abrirRelatorio = function() {
            toggleMenu(false); abrirModal('modal-report');
            const total = listaClientesLocal.length; const statusCount = { azul: 0, verde: 0, vermelho: 0 };
            listaClientesLocal.forEach(c => { let st = c.status || "azul"; statusCount[st] = (statusCount[st] || 0) + 1; });
            const dadosAgrupados = {};
            listaClientesLocal.forEach(c => {
                let cid = (c.cidade || "Sem Cidade").trim(); cid = cid.charAt(0).toUpperCase() + cid.slice(1).toLowerCase();
                let bai = (c.bairro || "Outros").trim();
                if (!dadosAgrupados[cid]) dadosAgrupados[cid] = {};
                if (!dadosAgrupados[cid][bai]) dadosAgrupados[cid][bai] = [];
                dadosAgrupados[cid][bai].push(c.nome);
            });
            const reportBody = document.getElementById('report-body'); if(!reportBody) return;
            let html = `<div class="relatorio-titulo" style="text-align:center; padding:20px 0;"><div style="font-size:40px; font-weight:800;">${total}</div><div class="relatorio-sub" style="font-size:12px;">CLIENTES TOTAIS</div></div><h4 class="relatorio-titulo" style="color:#0a84ff; margin:10px 0; font-size:12px;">STATUS GERAL</h4><table class="tabela-relatorio" style="margin-bottom:20px"><tr><td>Aberto</td><td style="text-align:right;">${statusCount.azul}</td></tr><tr><td>ConcluÃ­do</td><td style="text-align:right; color:#32d74b;">${statusCount.verde}</td></tr><tr><td>Sede</td><td style="text-align:right; color:#ff453a;">${statusCount.vermelho}</td></tr></table>`;
            Object.keys(dadosAgrupados).sort().forEach(cidade => {
                html += `<div class="city-block"><div class="city-title">${cidade}</div>`;
                Object.keys(dadosAgrupados[cidade]).sort().forEach(bairro => {
                    const clientes = dadosAgrupados[cidade][bairro];
                    const id = (cidade + bairro).replace(/[^a-zA-Z0-9]/g, '');
                    html += `<div class="bairro-container"><div class="bairro-header" onclick="toggleBairro('${id}')"><span>${bairro}</span><span style="background:#333; padding:2px 8px; border-radius:6px; font-size:12px;">${clientes.length}</span></div><div id="lista-${id}" class="bairro-lista">${clientes.map(nome => `<div class="cliente-no-bairro">${nome}</div>`).join('')}</div></div>`;
                });
                html += `</div>`;
            });
            reportBody.innerHTML = html;
        }

        window.toggleBairro = function(id) { const el = document.getElementById(`lista-${id}`); if(el) el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
        
        async function buscarEnderecoAutomatico(lat, lng) {
            const btnAuto = document.querySelector('.btn-auto-end'); const originalText = btnAuto.innerText; btnAuto.innerText = "â³";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`); const data = await res.json();
                if(data.address) {
                    let bairro = data.address.suburb || data.address.neighbourhood || data.address.residential || "";
                    let rua = data.address.road || "";
                    let cidade = data.address.city || data.address.town || data.address.municipality || "";
                    if(data.address.postcode) { const cepLimpo = data.address.postcode.replace(/\D/g, ''); try { const resCep = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`); const dataCep = await resCep.json(); if(!dataCep.erro) { if(dataCep.bairro) bairro = dataCep.bairro; if(dataCep.logradouro) rua = dataCep.logradouro; if(dataCep.localidade) cidade = dataCep.localidade; } } catch(e) {} }
                    setVal('inputBairro', bairro); setVal('inputCidade', cidade); if(rua) setVal('inputObs', rua);
                }
            } catch (e) { console.log(e); } finally { btnAuto.innerText = originalText; }
        }
        window.acionarBuscaManual = function() { if(coordSelecionada) buscarEnderecoAutomatico(coordSelecionada.lat, coordSelecionada.lng); }

        window.buscarPorCep = async function() {
            const cep = getVal('inputCep').replace(/\D/g, ''); if(cep.length !== 8) return alert("CEP InvÃ¡lido");
            const t = document.getElementById('toast-msg'); t.innerText = "Buscando CEP..."; t.style.display = 'block';
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const data = await res.json(); if(data.erro) throw new Error("CEP nÃ£o encontrado");
                setVal('inputCidade', data.localidade); setVal('inputBairro', data.bairro); setVal('inputObs', data.logradouro + ", ");
                const query = `${data.logradouro}, ${data.localidade}, Brasil`; const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`); const geoData = await geoRes.json();
                if(geoData && geoData.length > 0) { const lat = parseFloat(geoData[0].lat); const lon = parseFloat(geoData[0].lon); const novaCoord = { lat: lat, lng: lon }; map.flyTo(novaCoord, 16); if(tempMarker) map.removeLayer(tempMarker); tempMarker = L.marker(novaCoord).addTo(map); coordSelecionada = novaCoord; t.innerText = "Local encontrado!"; }
            } catch (e) { alert("Erro: " + e.message); } finally { setTimeout(() => t.style.display = 'none', 3000); }
        }

        window.abrirFormularioCEP = function() { fecharModais(); setTimeout(() => { abrirModal('modal-form'); document.getElementById('form-title').innerText = "Cadastro via CEP"; setVal('inputCep', ""); const campo = document.getElementById('inputCep'); if(campo) campo.focus(); }, 300); }

        window.editarCliente = function(id) {
            const c = listaClientesLocal.find(x => x.id === id); if (!c) return;
            ['inputNome','inputCidade','inputBairro','inputComprador','inputTel','inputObs'].forEach(k => setVal(k, c[k.replace('input','').toLowerCase()] || ""));
            setVal('inputStatus', c.status || "azul"); 
            const img = document.getElementById('preview-foto-edit');
            if(img) { img.src = c.foto || ""; img.style.display = c.foto ? 'block' : 'none'; }
            idParaEditar = id; coordSelecionada = { lat: c.lat, lng: c.lng }; document.getElementById('form-title').innerText = "Editar"; document.getElementById('btn-confirmar').innerText = "SALVAR ALTERAÃ‡Ã•ES"; abrirModal('modal-form');
        }

        window.salvarCliente = async function() {
            const user = auth.currentUser; if(!user) return; 
            const nome = getVal('inputNome'); if (!nome) return alert("Nome obrigatÃ³rio"); 
            const btn = document.getElementById('btn-confirmar'); const txtOriginal = btn.innerText; btn.innerText = "Salvando..."; 
            const load = document.getElementById('loading-overlay'); if(load) load.style.display = 'flex';
            const file = document.getElementById('inputFoto').files[0]; let fotoString = ""; if (file) fotoString = await redimensionarImagem(file); else if (idParaEditar) { const c = listaClientesLocal.find(x => x.id === idParaEditar); if(c) fotoString = c.foto; }
            const dados = { uid: user.uid, nome, cidade: getVal('inputCidade'), bairro: getVal('inputBairro'), status: getVal('inputStatus'), comprador: getVal('inputComprador'), telefone: getVal('inputTel'), obs: getVal('inputObs'), lat: coordSelecionada.lat, lng: coordSelecionada.lng, foto: fotoString, data: new Date() };
            try { if (idParaEditar) { await updateDoc(doc(db, "clientes", idParaEditar), dados); const index = listaClientesLocal.findIndex(x => x.id === idParaEditar); if(index !== -1) listaClientesLocal[index] = { id: idParaEditar, ...dados }; if(markersMap[idParaEditar]) map.removeLayer(markersMap[idParaEditar]); criarPino(dados, idParaEditar); } else { const docRef = await addDoc(collection(db, "clientes"), dados); listaClientesLocal.push({ id: docRef.id, ...dados }); criarPino(dados, docRef.id); } fecharModais(); const toast = document.getElementById('toast-msg'); toast.innerText = "Salvo com sucesso!"; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 3000); } catch (e) { alert("Erro ao salvar: " + e.message); } finally { if(load) load.style.display = 'none'; btn.innerText = txtOriginal; }
        }

        const redimensionarImagem = (file) => { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const cvs = document.createElement('canvas'); const scale = 1024 / img.width; cvs.width = 1024; cvs.height = img.height * scale; cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height); resolve(cvs.toDataURL('image/jpeg', 0.8)); }; }; }); }

        window.forcarRecarregamentoDados = async function() {
            toggleMenu(false); const user = auth.currentUser; if(!user) return;
            const t = document.getElementById('toast-msg'); t.innerText = "Atualizando sessÃ£o..."; t.style.display = 'block';
            try { await user.reload(); carregarClientes(true, user); } catch(e) { alert("SessÃ£o expirada. Por favor, saia e entre novamente."); }
        }

        async function carregarClientes(forcar = false, userProvided = null) {
            const user = userProvided || auth.currentUser; if(!user) return;
            if(forcar) { const t = document.getElementById('toast-msg'); t.innerText = "Baixando dados..."; t.style.display = 'block'; }
            try {
                const q = query(collection(db, "clientes"), where("uid", "==", user.uid));
                const snap = await getDocs(q);
                listaClientesLocal = []; for (const id in markersMap) { map.removeLayer(markersMap[id]); } markersMap = {};
                snap.forEach((doc) => { const d = doc.data(); listaClientesLocal.push({ id: doc.id, ...d }); criarPino(d, doc.id); });
                if(forcar) { const t = document.getElementById('toast-msg'); t.innerText = `${listaClientesLocal.length} Clientes.`; setTimeout(() => t.style.display = 'none', 3000); }
                if (listaClientesLocal.length === 0 && !forcar) { setTimeout(() => { carregarClientes(true, user); }, 2000); }
            } catch (error) { if(forcar) alert("Erro: " + error.message); }
        }

        window.carregarClientes = carregarClientes;

        function criarPino(d, id) {
            let icone = blueIcon; if (d.status === 'verde') icone = greenIcon; if (d.status === 'vermelho') icone = redIcon;
            const m = L.marker([d.lat, d.lng], { icon: icone }).addTo(map); markersMap[id] = m;
            let imgHTML = d.foto ? `<div class="popup-foto-container" onclick="verFotoGrande('${d.foto}')"><img src="${d.foto}" style="width:100%; height:120px; object-fit:cover;"></div>` : "";
            m.bindPopup(`<div style="font-family:-apple-system; color:#333; text-align:center; min-width:200px;">${imgHTML}<h3 style="margin:0 0 5px 0; font-size:16px;">${d.nome}</h3><div style="font-size:12px; color:#666; margin-bottom:8px;">${d.bairro || ""} - ${d.cidade || ""}</div><div style="display:flex; gap:8px; justify-content:center;"><button onclick="window.open('http://maps.google.com/maps?daddr=${d.lat},${d.lng}')" style="background:#0a84ff; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;"><i class="fas fa-car"></i></button><button onclick="abrirNovoPedido('${id}', '${d.nome}')" style="background:#bf5af2; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;"><i class="fas fa-clipboard-list"></i></button><button onclick="editarCliente('${id}')" style="background:#ff9500; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;"><i class="fas fa-pen"></i></button><button onclick="deletarCliente('${id}')" style="background:#ff453a; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;"><i class="fas fa-trash"></i></button></div>${d.telefone ? `<div onclick="escolherContato('${d.telefone}')" style="margin-top:8px; color:#0a84ff; cursor:pointer; font-weight:600;">ðŸ“ž Contato</div>` : ''}</div>`);
        }

        window.deletarCliente = async (id) => { if(confirm("Apagar permanentemente?")) { await deleteDoc(doc(db, "clientes", id)); if(markersMap[id]) map.removeLayer(markersMap[id]); listaClientesLocal = listaClientesLocal.filter(c => c.id !== id); delete markersMap[id]; } }

        window.abrirEscolha = () => abrirModal('modal-escolha');
        window.fecharModais = () => { 
            coordSelecionada = null; idParaEditar = null; if(tempMarker) map.removeLayer(tempMarker);
            document.querySelectorAll('.modal').forEach(m => { m.classList.remove('visible'); m.classList.remove('active-pc'); }); 
            const overlay = document.getElementById('overlay'); if(overlay) overlay.classList.remove('visible');
            if(timerLimpeza) clearTimeout(timerLimpeza); 
            timerLimpeza = setTimeout(() => { 
                document.querySelectorAll('.modal').forEach(e => e.style.display = 'none'); 
                if(overlay) overlay.style.display = 'none';
                setStyle('fab-add','display','flex'); setStyle('search-container','display','block');
                ['inputNome','inputCidade','inputBairro','inputObs','inputTel','inputComprador','inputFoto'].forEach(id => setVal(id, "")); 
                setStyle('preview-foto-edit', 'display', 'none'); 
            }, 600); 
        }
        window.usarMapaManual = () => { fecharModais(); setStyle('fab-add', 'display', 'none'); setStyle('search-container', 'display', 'none'); setStyle('center-pin', 'display', 'block'); setStyle('manual-actions', 'display', 'flex'); }
        window.cancelarMapaManual = () => { setStyle('center-pin', 'display', 'none'); setStyle('manual-actions', 'display', 'none'); setStyle('fab-add', 'display', 'flex'); setStyle('search-container', 'display', 'block'); }
        window.confirmarLocalizacaoManual = () => { const center = map.getCenter(); setStyle('center-pin', 'display', 'none'); setStyle('manual-actions', 'display', 'none'); posicionarPinoFormulario(center); }
        window.usarGPS = () => { if(!navigator.geolocation) return alert("Sem GPS"); fecharModais(); const t = document.getElementById('toast-msg'); t.style.display = 'block'; t.innerText = "Buscando..."; navigator.geolocation.getCurrentPosition(p => { const ll = { lat: p.coords.latitude, lng: p.coords.longitude }; map.flyTo(ll, 17); posicionarPinoFormulario(ll); }); }
        function posicionarPinoFormulario(ll) { coordSelecionada = ll; if(tempMarker) map.removeLayer(tempMarker); tempMarker = L.marker(ll).addTo(map); idParaEditar = null; document.getElementById('form-title').innerText = "Novo Cadastro"; document.getElementById('btn-confirmar').innerText = "SALVAR"; document.getElementById('toast-msg').style.display = 'none'; buscarEnderecoAutomatico(ll.lat, ll.lng); setTimeout(() => abrirModal('modal-form'), 300); }
    </script>
</body>
</html>